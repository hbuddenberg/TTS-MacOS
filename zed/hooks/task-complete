#!/bin/bash
# Hook de tarea completada en Zed: Notifica cuando una tarea compleja se completa
# Este hook se ejecuta después de tareas como compilación, prueba, etc.

# Configuración
VOICE="${ZED_TTS_TASK_VOICE:-jorge}"   # Voz diferente para tareas
RATE="${ZED_TTS_TASK_RATE:-180}"       # Velocidad normal
ENABLED="${ZED_TTS_ENABLED:-false}"    # Habilitar/deshabilitar el TTS

# Salir si está deshabilitado
if [ "$ENABLED" != "true" ]; then
    exit 0
fi

# Leer la operación y resultado desde argumentos o stdin
if [ $# -gt 0 ]; then
    OPERATION="$1"
    RESULT="$2"
else
    OPERATION=$(cat | head -n 1)
    RESULT=$(cat | tail -n +2)
fi

# Determinar el tipo de mensaje basado en la operación
case "$OPERATION" in
    *build*)
        MSG="Compilación"
        ;;
    *test*)
        MSG="Pruebas"
        ;;
    *lint*)
        MSG="Análisis de código"
        ;;
    *format*)
        MSG="Formateo"
        ;;
    *deploy*)
        MSG="Despliegue"
        ;;
    *install*)
        MSG="Instalación"
        ;;
    *run*)
        MSG="Ejecución"
        ;;
    *)
        MSG="Tarea"
        ;;
esac

# Añadir resultado al mensaje
if [ -n "$RESULT" ]; then
    case "$RESULT" in
        *success*|*exitoso*|*completado*|*completed*|*ok*)
            MSG="$MSG completada exitosamente"
            ;;
        *error*|*fail*|*falló*|*fallo*)
            MSG="$MSG con errores, revisa la consola"
            ;;
        *warning*)
            MSG="$MSG con advertencias"
            ;;
        *)
            MSG="$MSG: $RESULT"
            ;;
    esac
else
    MSG="$MSG completada"
fi

# Función para buscar voz en el sistema
find_voice() {
    local voice_query="$1"

    # Búsqueda exacta primero (case-insensitive)
    local exact_match=$(say -v ? | grep -i "^${voice_query} " | head -1 | awk '{print $1}')
    if [ -n "$exact_match" ]; then
        echo "$exact_match"
        return 0
    fi

    # Búsqueda parcial (para voces como "Siri Female", "Siri Male")
    local partial_match=$(say -v ? | grep -i "$voice_query" | head -1 | awk '{print $1}')
    if [ -n "$partial_match" ]; then
        echo "$partial_match"
        return 0
    fi

    # Fallback: buscar cualquier voz en español
    local spanish_voice=$(say -v ? | grep -iE "(spanish|español)" | head -1 | awk '{print $1}')
    if [ -n "$spanish_voice" ]; then
        echo "$spanish_voice"
        return 0
    fi

    # Último fallback: Jorge o primera voz disponible
    echo "Jorge"
}

# Buscar la voz en el sistema
VOICE_NAME=$(find_voice "$VOICE")

# Reproducir usando TTS-macOS CLI (si está instalado)
if command -v tts-macos &> /dev/null; then
    tts-macos "$MSG" --voice "$(echo "$VOICE_NAME" | tr '[:upper:]' '[:lower:]')" --rate "$RATE" 2>/dev/null &
    exit 0
fi

# Fallback: usar say directamente
say -v "$VOICE_NAME" -r "$RATE" "$MSG" 2>/dev/null &

exit 0
