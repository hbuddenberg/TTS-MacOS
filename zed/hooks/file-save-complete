#!/bin/bash
# Hook de guardado de archivo en Zed: Notifica cuando un archivo se guarda correctamente
# Este hook se ejecuta después de guardar un archivo en Zed

# Configuración
VOICE="${ZED_TTS_VOICE:-monica}"       # Voz por defecto
RATE="${ZED_TTS_RATE:-175}"            # Velocidad en palabras por minuto
ENABLED="${ZED_TTS_ENABLED:-false}"    # Habilitar/deshabilitar el TTS
MAX_LENGTH="${ZED_TTS_MAX_LENGTH:-100}" # Longitud máxima para notificaciones

# Salir si está deshabilitado
if [ "$ENABLED" != "true" ]; then
    exit 0
fi

# Leer el nombre del archivo desde el primer argumento o stdin
if [ $# -gt 0 ]; then
    FILE_NAME="$1"
else
    FILE_NAME=$(cat)
fi

# Si no hay nombre de archivo, salir
if [ -z "$FILE_NAME" ]; then
    exit 0
fi

# Mensaje de confirmación basado en tipo de archivo
EXTENSION=$(echo "$FILE_NAME" | grep -o '\.[^.]*$' | tr '[:upper:]' '[:lower:]')

case "$EXTENSION" in
    .py)
        MSG="Archivo Python guardado exitosamente: $(basename "$FILE_NAME")"
        ;;
    .js|.ts|.jsx|.tsx)
        MSG="Archivo JavaScript guardado: $(basename "$FILE_NAME")"
        ;;
    .md)
        MSG="Documento Markdown guardado: $(basename "$FILE_NAME")"
        ;;
    .json)
        MSG="Archivo JSON guardado: $(basename "$FILE_NAME")"
        ;;
    .sh|.bash|.zsh)
        MSG="Script guardado: $(basename "$FILE_NAME")"
        ;;
    .html|.css|.scss)
        MSG="Archivo web guardado: $(basename "$FILE_NAME")"
        ;;
    *)
        MSG="Archivo guardado: $(basename "$FILE_NAME")"
        ;;
esac

# Truncar si es muy largo
MSG=$(echo "$MSG" | head -c "$MAX_LENGTH")

# Función para buscar voz en el sistema
find_voice() {
    local voice_query="$1"

    # Búsqueda exacta primero (case-insensitive)
    local exact_match=$(say -v ? | grep -i "^${voice_query} " | head -1 | awk '{print $1}')
    if [ -n "$exact_match" ]; then
        echo "$exact_match"
        return 0
    fi

    # Búsqueda parcial (para voces como "Siri Female", "Siri Male")
    local partial_match=$(say -v ? | grep -i "$voice_query" | head -1 | awk '{print $1}')
    if [ -n "$partial_match" ]; then
        echo "$partial_match"
        return 0
    fi

    # Fallback: buscar cualquier voz en español
    local spanish_voice=$(say -v ? | grep -iE "(spanish|español)" | head -1 | awk '{print $1}')
    if [ -n "$spanish_voice" ]; then
        echo "$spanish_voice"
        return 0
    fi

    # Último fallback: Monica o primera voz disponible
    echo "Monica"
}

# Buscar la voz en el sistema
VOICE_NAME=$(find_voice "$VOICE")

# Reproducir usando TTS-macOS CLI (si está instalado)
if command -v tts-macos &> /dev/null; then
    tts-macos "$MSG" --voice "$(echo "$VOICE_NAME" | tr '[:upper:]' '[:lower:]')" --rate "$RATE" 2>/dev/null &
    exit 0
fi

# Fallback: usar say directamente
say -v "$VOICE_NAME" -r "$RATE" "$MSG" 2>/dev/null &

exit 0
